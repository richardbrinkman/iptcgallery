mysql -u root -h 127.0.0.1 << EOF
CREATE DATABASE IF NOT EXISTS gallery;
GRANT ALL PRIVILEGES ON gallery.* TO php@localhost IDENTIFIED BY 'f2jffwjfw29134agfa';
USE gallery;
DROP TABLE IF EXISTS iptc;
CREATE TABLE iptc(
	iptc_id CHAR(5) NOT NULL PRIMARY KEY,
	iptc_name varchar(25) NOT NULL UNIQUE KEY
);
CREATE TABLE IF NOT EXISTS directory(
	directory_id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	dirname VARCHAR(255) NOT NULL UNIQUE KEY
);
CREATE TABLE IF NOT EXISTS photo(
	photo_id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	directory_id INT NOT NULL,
	filename VARCHAR(255) NOT NULL UNIQUE KEY,
	width SMALLINT,
	height SMALLINT,
	last_modified TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	FOREIGN KEY(directory_id) REFERENCES directory(directory_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE TABLE IF NOT EXISTS thumbnail(
	thumbnail_id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	photo_id INT NOT NULL,
	width SMALLINT,
	height SMALLINT,
	image BLOB,
	last_modified TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	FOREIGN KEY(photo_id) REFERENCES photo(photo_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE TABLE IF NOT EXISTS tag(
	tag_id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	iptc_id CHAR(5) NOT NULL,
	value VARCHAR(255) NOT NULL,
	UNIQUE KEY(iptc_id, value),
	FOREIGN KEY(iptc_id) REFERENCES iptc(iptc_id) ON DELETE CASCADE ON UPDATE CASCADE
);
CREATE TABLE IF NOT EXISTS link(
	tag_id INT NOT NULL,
	photo_id INT NOT NULL,
	FOREIGN KEY(tag_id) REFERENCES tag(tag_id) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY(photo_id) REFERENCES photo(photo_id) ON DELETE CASCADE ON UPDATE CASCADE
);
EOF
iptc -l | grep : | sed -e 's/^\ \([0-9]\):\([0-9][0-9][0-9]\)\ \(.*\)$/INSERT INTO iptc(iptc_id,iptc_name) VALUES("\1#\2", "\3");/' | mysql --user=root --host=127.0.0.1 --database=gallery
